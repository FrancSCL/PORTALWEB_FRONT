# üîß **CORRECCI√ìN DE RESPUESTA - ENDPOINT CONFIGURACIONES AGRUPADAS**

---

## üéØ **PROBLEMA IDENTIFICADO**

Hola equipo Backend,

El endpoint `/api/pautas/configuraciones-agrupadas` **S√ç est√° funcionando** y devolviendo datos, pero la estructura de la respuesta no coincide con lo que espera el frontend.

---

## üìä **ESTRUCTURA ACTUAL DEL BACKEND**

### **‚úÖ Respuesta Actual (Funcionando):**
```json
{
  "data": {
## üì£ Solicitud de verificaci√≥n y correcci√≥n de endpoints Detalle de Cuartel

Hola equipo Backend,

Estamos consumiendo los nuevos endpoints del Detalle de Cuartel desde el frontend y detectamos algunos errores SQL/columnas que impiden la carga. ¬øPueden, por favor, revisar y confirmar las columnas correctas o aplicar los ajustes indicados? Detallo por endpoint:

1) GET /api/estimaciones/cuartel/{id}/informacion-general
- Error: 1054 (42S22): Unknown column 'c.plantas_ha_teoricas' in 'field list'
- Acci√≥n: si la columna real es c.plantas_teoricas_ha (u otro nombre), usarla y exponer el alias como plantas_ha_teoricas en el JSON. Si no existe, retornar 0/null manteniendo el nombre plantas_ha_teoricas.
- Campos esperados en JSON (todos ya soportados por el frontend): id, nombre, variedad, nombre_ceco, nombre_sucursal, superficie_productiva, a√±o_plantacion, plantas_ha_teoricas, portainjerto, estado_productivo, numero_brazos_ejes.

2) GET /api/estimaciones/cuartel/{id}/estimaciones
- Error: 1146 (42S02): Table 'estimacion_dim_tipo' doesn't exist
- Acci√≥n: si no existe la dimensi√≥n, devolver tipo_estimacion desde la fact o como texto derivado; si hay otra tabla equivalente, ajustar el JOIN. Mantener la estructura { estimaciones: [{ id, tipo_estimacion, estimacion_cajas_ha, estimacion, fecha, usuario }] }.

3) GET /api/estimaciones/cuartel/{id}/pautas
- Errores:
  - 1054 (42S22): Unknown column 'p.id_estado' in 'field list' ‚Üí usar la columna existente (p.estado) o equivalente y exponer como estado.
  - 1054 (42S22): Unknown column 'p.id_usuario' in 'where clause' ‚Üí usar la columna correcta para filtrar por usuario si corresponde, o quitar filtro si no aplica. El frontend filtra por sucursal v√≠a token global.

4) GET /api/estimaciones/cuartel/{id}/mapeos
- Error: 1054 (42S22): Unknown column 'm.fecha' in 'field list'
- Acci√≥n: usar el nombre real de la fecha (por ejemplo m.fecha_registro) y exponerlo como fecha en el JSON. Campos esperados: fecha, plantas_7, plantas_5, plantas_3, usuario.

5) GET /api/estimaciones/cuartel/{id}/frutos-ramilla-historico
- Error: 1054 (42S22): Unknown column 'cv.fecha' in 'field list'
- Acci√≥n: usar la columna real de fecha (probablemente en la fact) y exponer como fecha. Campos esperados: { id, frutos_ramilla, fecha, usuario }.

6) GET /api/estimaciones/cuartel/{id}/calibres-historicos
- (Sin errores reportados a√∫n) Confirmar que devuelven { id, fecha, calibre, cantidad, usuario }.

Recomendaciones de respuesta consistentes
- Mantener estructura: { success, message, data }
- Cuando no haya datos, retornar 200 con arrays vac√≠os (success=true) en lugar de 500.
- Validar sucursal del usuario por token; si el cuartel no pertenece, 404 con mensaje claro.

¬øPueden confirmar y, de ser necesario, aplicar estos ajustes? Apenas est√©, probamos nuevamente desde el frontend.

¬°Gracias!
      {
        "configuraciones": [
          {++
            "id": 1,
            "id_atributo": 2,
            "id_conteotipo": 1,
            "id_empresa": 1,
            "id_tipoplanta": "4",
            "nombre_atributo": "FRUTOS",
            "nombre_tipo_planta": "Sin tipo"
          },
          {
            "id": 2,
            "id_atributo": 2,
            "id_conteotipo": 1,
            "id_empresa": 1,
            "id_tipoplanta": "3",
            "nombre_atributo": "FRUTOS",
            "nombre_tipo_planta": "Sin tipo"
          }
        ]
      }
      
    ]
  }
}
```

---

## üéØ **ESTRUCTURA ESPERADA POR EL FRONTEND**

### **üìã Respuesta Esperada:**
```json
{
  "success": true,
  "message": "Configuraciones agrupadas obtenidas exitosamente",
  "data": {
    "tipos_conteo": [
      {
        "id_conteotipo": 1,
        "nombre_labor": "RALEO",
        "nombre_especie": "NECTARIN",
        "total_configuraciones": 6,
        "configuraciones": [
          {
            "id": 1,
            "id_empresa": 1,
            "id_conteotipo": 1,
            "id_atributo": 2,
            "id_tipoplanta": "4",
            "nombre_atributo": "FRUTOS",
            "nombre_tipo_planta": "Sin tipo"
          },
          {
            "id": 2,
            "id_empresa": 1,
            "id_conteotipo": 1,
            "id_atributo": 2,
            "id_tipoplanta": "3",
            "nombre_atributo": "FRUTOS",
            "nombre_tipo_planta": "Sin tipo"
          }
        ]
      }
    ],
    "total_tipos_conteo": 1,
    "total_configuraciones": 6
  }
}
```

---

## üîç **CAMBIOS NECESARIOS**

### **1. Agregar Campos Faltantes en `tipos_conteo`:**
- **`id_conteotipo`** - ID del tipo de conteo
- **`nombre_labor`** - Nombre de la labor (ej: "RALEO")
- **`nombre_especie`** - Nombre de la especie (ej: "NECTARIN")
- **`total_configuraciones`** - N√∫mero de configuraciones en este tipo

### **2. Agregar Campos Faltantes en `data`:**
- **`total_tipos_conteo`** - N√∫mero total de tipos de conteo
- **`total_configuraciones`** - N√∫mero total de configuraciones

### **3. Agregar Campos de Respuesta Est√°ndar:**
- **`success: true`** - Indicador de √©xito
- **`message`** - Mensaje descriptivo

---

## üîß **IMPLEMENTACI√ìN SUGERIDA**

### **SQL Query Actualizado:**
```sql
SELECT 
    cp.id_conteotipo,
    le.nombre_labor,
    le.nombre_especie,
    COUNT(cp.id) as total_configuraciones,
    JSON_ARRAYAGG(
        JSON_OBJECT(
            'id', cp.id,
            'id_empresa', cp.id_empresa,
            'id_conteotipo', cp.id_conteotipo,
            'id_atributo', cp.id_atributo,
            'id_tipoplanta', cp.id_tipoplanta,
            'nombre_atributo', a.nombre,
            'nombre_tipo_planta', COALESCE(tp.nombre, 'Sin tipo')
        )
    ) as configuraciones
FROM conteo_dim_configpauta cp
JOIN conteo_pivot_labor_especie le ON cp.id_conteotipo = le.id
JOIN conteo_dim_atributocultivo a ON cp.id_atributo = a.id
LEFT JOIN mapeo_dim_tipoplanta tp ON cp.id_tipoplanta = tp.id
GROUP BY cp.id_conteotipo, le.nombre_labor, le.nombre_especie
ORDER BY le.nombre_labor, le.nombre_especie;
```

### **Python Flask Route Actualizado:**
```python
@pautas_bp.route('/configuraciones-agrupadas', methods=['GET'])
@jwt_required()
def get_configuraciones_agrupadas():
    try:
        # Obtener configuraciones agrupadas por tipo de conteo
        query = """
        SELECT 
            cp.id_conteotipo,
            le.nombre_labor,
            le.nombre_especie,
            COUNT(cp.id) as total_configuraciones,
            JSON_ARRAYAGG(
                JSON_OBJECT(
                    'id', cp.id,
                    'id_empresa', cp.id_empresa,
                    'id_conteotipo', cp.id_conteotipo,
                    'id_atributo', cp.id_atributo,
                    'id_tipoplanta', cp.id_tipoplanta,
                    'nombre_atributo', a.nombre,
                    'nombre_tipo_planta', COALESCE(tp.nombre, 'Sin tipo')
                )
            ) as configuraciones
        FROM conteo_dim_configpauta cp
        JOIN conteo_pivot_labor_especie le ON cp.id_conteotipo = le.id
        JOIN conteo_dim_atributocultivo a ON cp.id_atributo = a.id
        LEFT JOIN mapeo_dim_tipoplanta tp ON cp.id_tipoplanta = tp.id
        GROUP BY cp.id_conteotipo, le.nombre_labor, le.nombre_especie
        ORDER BY le.nombre_labor, le.nombre_especie
        """
        
        result = db.session.execute(text(query))
        tipos_conteo = []
        total_configuraciones = 0
        
        for row in result:
            configuraciones = json.loads(row.configuraciones) if row.configuraciones else []
            tipos_conteo.append({
                'id_conteotipo': row.id_conteotipo,
                'nombre_labor': row.nombre_labor,
                'nombre_especie': row.nombre_especie,
                'total_configuraciones': row.total_configuraciones,
                'configuraciones': configuraciones
            })
            total_configuraciones += row.total_configuraciones
        
        return jsonify({
            'success': True,
            'message': 'Configuraciones agrupadas obtenidas exitosamente',
            'data': {
                'tipos_conteo': tipos_conteo,
                'total_tipos_conteo': len(tipos_conteo),
                'total_configuraciones': total_configuraciones
            }
        })
        
    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'Error al obtener configuraciones agrupadas: {str(e)}'
        }), 500
```

---

## üéØ **CAMPOS CR√çTICOS FALTANTES**

### **En cada `tipo_conteo`:**
- **`nombre_labor`** - Para mostrar "RALEO - NECTARIN"
- **`nombre_especie`** - Para mostrar "RALEO - NECTARIN"
- **`total_configuraciones`** - Para mostrar "(6 configuraciones)"

### **En el nivel `data`:**
- **`total_configuraciones`** - Para el contador total
- **`total_tipos_conteo`** - Para estad√≠sticas

### **En el nivel ra√≠z:**
- **`success: true`** - Para verificaci√≥n de √©xito
- **`message`** - Para feedback al usuario

---

## üì± **IMPACTO EN EL FRONTEND**

### **‚úÖ Con la Correcci√≥n:**
- **Vista agrupada** funcionar√° correctamente
- **T√≠tulos** mostrar√°n "RALEO - NECTARIN"
- **Contadores** mostrar√°n "(6 configuraciones)"
- **Expansi√≥n** mostrar√° todas las configuraciones

### **‚ùå Sin la Correcci√≥n:**
- **Vista vac√≠a** (no se muestran configuraciones)
- **T√≠tulos** aparecen como "Sin labor - Sin especie"
- **Contadores** no funcionan correctamente

---

## üöÄ **PRIORIDAD**

### **üî• CR√çTICA:**
- **`nombre_labor`** y **`nombre_especie`** - Esenciales para mostrar t√≠tulos
- **`total_configuraciones`** - Esencial para contadores
- **`success: true`** - Esencial para verificaci√≥n

### **‚≠ê IMPORTANTE:**
- **`total_tipos_conteo`** - Para estad√≠sticas
- **`message`** - Para feedback

---

## üìù **RESUMEN**

**El endpoint est√° funcionando pero necesita estos campos adicionales:**

1. **`nombre_labor`** y **`nombre_especie`** en cada tipo de conteo
2. **`total_configuraciones`** en cada tipo de conteo
3. **`total_configuraciones`** y **`total_tipos_conteo`** en data
4. **`success: true`** y **`message`** en la respuesta

**Con estos cambios, el frontend podr√° mostrar correctamente la vista agrupada con t√≠tulos como "RALEO - NECTARIN (6 configuraciones)".**

**üìÖ Fecha**: 25 de Agosto 2025  
**üîß Versi√≥n**: 1.0.0  
**üìã Estado**: ‚ö†Ô∏è CORRECCI√ìN SOLICITADA - ENDPOINT FUNCIONANDO PERO INCOMPLETO

---

## üéØ **ACCI√ìN INMEDIATA**

**Agregar los campos faltantes al endpoint `/api/pautas/configuraciones-agrupadas` para que el frontend pueda mostrar correctamente la vista agrupada.**

**¬°Gracias por la correcci√≥n!** üöÄ
